---
title: 3.4. with Process
category: 하나씩 익히는 Container
date: 2020-07-20T12:00:00Z
lastmod: 2020-07-20T12:00:00Z
comment: true
adsense: true
---

### Namespace와 관련된 Process의 특징

Namespace와 Process는 밀접한 관계를 가지고 있다. Namespace와 Process 사이의 관계를 통해서 Namespace의 특징을 알아본다. 먼저 모든 Process들은 반드시 특정 Namespace에 소속되어있다. 따라서 Container의 Process뿐만 아니라 Host의 Process들도 Host Namespace에 소속되어 동작한다. fork(2) 또는 clone(2) System Call을 이용하여 Child Process를 생성하는 경우, Namespace 관련 설정을 적용하지 않는 이상 기본적으로 Child Process는 Parent Process가 이용하는 Namespace를 상속받아 그대로 이용한다.

{% highlight console %}
# Host의 Init (systemd) Process의 Namespace 확인 
(host)# ls -l /proc/1/ns
lrwxrwxrwx 1 root root 0 Oct 10 15:07 ipc -> 'ipc:[4026531839]'
lrwxrwxrwx 1 root root 0 Oct 10 15:07 mnt -> 'mnt:[4026531840]'
lrwxrwxrwx 1 root root 0 Oct 10 15:07 net -> 'net:[4026531993]'
lrwxrwxrwx 1 root root 0 Oct 10 15:07 pid -> 'pid:[4026531836]'
lrwxrwxrwx 1 root root 0 Oct 10 15:07 user -> 'user:[4026531837]'
lrwxrwxrwx 1 root root 0 Oct 10 15:07 uts -> 'uts:[4026531838]'

# Host에서 SSH Daemon Process의 Namespace 확인
(host)# ps -ef | grep sshd
root      1328     1  0 Oct05 ?        00:00:00 /usr/sbin/sshd -D
(host)# ls -l /proc/1328/ns
lrwxrwxrwx 1 root root 0 Oct 10 15:07 ipc -> 'ipc:[4026531839]'
lrwxrwxrwx 1 root root 0 Oct 10 15:07 mnt -> 'mnt:[4026531840]'
lrwxrwxrwx 1 root root 0 Oct 10 15:07 net -> 'net:[4026531993]'
lrwxrwxrwx 1 root root 0 Oct 10 15:07 pid -> 'pid:[4026531836]'
lrwxrwxrwx 1 root root 0 Oct 10 15:07 user -> 'user:[4026531837]'
lrwxrwxrwx 1 root root 0 Oct 10 15:07 uts -> 'uts:[4026531838]'

# nginx Container를 Daemon으로 실행하고 Host에서 보이는 nginx Container의 Init Process의 PID 확인
(host)# docker run -d --rm --name nginx nginx:1.16.1
(host)# docker inspect -f '{{.State.Pid}}' nginx
1000

# nginx Container의 Init Process의 Namespace 확인
(host)# ls -l /proc/1000/ns
lrwxrwxrwx 1 root root 0 Oct 10 15:42 ipc -> 'ipc:[4026532161]'
lrwxrwxrwx 1 root root 0 Oct 10 15:42 mnt -> 'mnt:[4026532159]'
lrwxrwxrwx 1 root root 0 Oct 10 15:40 net -> 'net:[4026532164]'
lrwxrwxrwx 1 root root 0 Oct 10 15:42 pid -> 'pid:[4026532162]'
lrwxrwxrwx 1 root root 0 Oct 10 15:42 user -> 'user:[4026531837]'
lrwxrwxrwx 1 root root 0 Oct 10 15:42 uts -> 'uts:[4026532160]'
{% endhighlight %}
<figure>
<figcaption class="caption">[Shell 1] Host Process와 Container Process의 Namespace 확인</figcaption>
</figure>

[Shell 1]에서는 Host Process와 Container Process의 Namespace를 확인하는 과정을 나타내고 있다. [Shell 1]의 내용을 통해서 위해서 언급한 Process의 Namespace 관련 특징들을 확인할 수 있다. Process가 소속되어 있는 Namespace는 /proc/[PID]/ns Directory에 Symbolic Link로 존재한다. 각 Namespace별로 Symbolic Link가 존재하며 숫자는 Symbolic Link의 inode 숫자를 의미한다.

[Shell 1]에서 /proc/1/ns의 Symbolic Link와 /proc/1328/ns의 Symbolic Link가 동일한 inode 숫자를 갖고 있는걸 확인할 수 있다. Host의 Init Process와 Host의 SSH Daemon Process가 동일한 Namespace를 이용한다는 의미이다. Host의 Init Process인 systemd의 Child Process가 SSH Daemon Process이기 때문이고, 별다른 Namespace 관련 설정을 적용하지 않았기 때문에 SSH Daemon Process는 systemd Process와 동일한 Namespace를 이용하고 있는 것이다.

[Shell 1]에서 /proc/1/ns의 Symbolic Link와 /proc/1000/ns의 Symbolic Link가 다른것을 확인할 수 있다. PID 1000은 Host PID Namespace에서 보이는 nginx Container의 Init Process의 PID이다. 즉 Host의 Namespace와 nginx Container의 Namespace가 다르다는 것을 알 수 있다.

### Process와 관련된 Namespace의 특징

**Namespace는 Namespace에 소속되어 있는 Process가 존재하지 않는 경우 Linux Kernel에 의해서 자동으로 제거된다.** 즉 Namespace가 생성되기 위해서는 Namespace에 소속되어 있는 Process가 반드시 존재해야 한다는 의미이기도 하다. 이러한 이유 때문에 Namespace와 관련된 System Call들은 모두 Process와 연관되어 있다. 아래는 Namespace과 관련된 System Call들이다.

* clone(2) : Process를 생성하는 fork(2) System Call의 확장판이다. CLONE_NEW* Option을 통해서 새로 생성되는 Process가 
* setns(2) : 
* unshare(2) : 
